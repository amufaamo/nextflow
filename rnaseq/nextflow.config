/*
 * ================================================================================================
 * ğŸ³ Nextflow Configuration File
 * ================================================================================================
 */

// --- 1. æ—¥æ™‚ã®å®šç¾© (yyyy-MM-dd_HH-mm-ss) ---
def timestamp = new Date().format("yyyy-MM-dd_HH-mm-ss")

// --- 2. workãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è‡ªå‹•è¨­å®š ---
workDir = "work/run_${timestamp}"

params {
    // --- å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š ---
    outdir                = "results"
    tracedir              = "${params.outdir}/pipeline_info"
    
    // --- å…±é€šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ---
    single_end            = false 
    adapter_fasta         = "${System.getProperty("user.home")}/fasta/adapter.fasta"
    fastq_dir             = "${System.getProperty("user.home")}/fastq"
    cpus                  = 8
    
    // --- FeatureCountsç”¨è¨­å®š ---
    fc_group_features     = 'gene_id'
    
    // --- STARè¨­å®š ---
    star_index_nbases     = 14
    // â˜…è¿½åŠ : BAMã‚½ãƒ¼ãƒˆã«ä½¿ã†ãƒ¡ãƒ¢ãƒªé‡ (STARå†…éƒ¨ç”¨)
    // ãƒã‚·ãƒ³ã‚¹ãƒšãƒƒã‚¯ã«åˆã‚ã›ã¦å¤‰æ›´å¯èƒ½ã§ã™ï¼ˆä¾‹: '10.GB', '60.GB'ï¼‰
    star_bam_sort_ram     = '30.GB'

    // --- De novoç”¨è¨­å®š ---
    denovo                = false 
    busco_lineage         = "eukaryota_odb10"
    busco_download_path   = "./busco_downloads"
}

process {
    // å…±é€šã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 2

    // â˜…è¿½åŠ : STAR_ALIGN å°‚ç”¨ã®ãƒªã‚½ãƒ¼ã‚¹è¨­å®š
    withName: 'STAR_ALIGN' {
        // ã‚³ãƒ³ãƒ†ãƒŠ/ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã«å‰²ã‚Šå½“ã¦ã‚‹ãƒ¡ãƒ¢ãƒªä¸Šé™
        // æ³¨æ„: STARã¯ã€Œã‚²ãƒãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(ç´„30GB)ã€+ã€Œã‚½ãƒ¼ãƒˆç”¨ãƒ¡ãƒ¢ãƒª(30GB)ã€ã‚’ä½¿ã†ãŸã‚ã€
        // åˆè¨ˆã§60GBä»¥ä¸Šç¢ºä¿ã™ã‚‹ã®ãŒå®‰å…¨ã§ã™ã€‚
        memory = '64 GB' 
        
        // STARã®è¨ˆç®—ã¯é‡ã„ã®ã§ã€ã“ã“ã ã‘CPUã‚’å¢—ã‚„ã™ã®ã‚‚æœ‰åŠ¹ã§ã™
        cpus   = 16
    }
}

profiles {
    standard {
        apptainer.enabled    = true
        apptainer.autoMounts = true
        docker.enabled       = false
        apptainer.cacheDir   = "${System.getProperty("user.home")}/apptainer_images"
    }

    apptainer {
        apptainer.enabled    = true
        apptainer.autoMounts = true
        docker.enabled       = false
        apptainer.cacheDir   = "${System.getProperty("user.home")}/apptainer_images"
    }

    docker {
        docker.enabled       = true
        docker.runOptions    = '-u $(id -u):$(id -g)'
        apptainer.enabled    = false
    }
}

// --- ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ---
timeline {
    enabled = true
    file    = "${params.tracedir}/execution_timeline_${timestamp}.html"
}
report {
    enabled = true
    file    = "${params.tracedir}/execution_report_${timestamp}.html"
}