/*
 * ================================================================================================
 * ğŸ³ Nextflow Configuration File
 * ================================================================================================
 */

// --- 1. æ—¥æ™‚ã®å®šç¾© (yyyy-MM-dd_HH-mm-ss) ---
def timestamp = new Date().format("yyyy-MM-dd_HH-mm-ss")

// --- 2. workãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è‡ªå‹•è¨­å®š ---
workDir = "work/run_${timestamp}"

params {
    // --- å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š ---
    outdir                = "results"
    tracedir              = "${params.outdir}/pipeline_info"
    
    // --- å…±é€šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ---
    single_end            = false 
    adapter_fasta         = "${System.getProperty("user.home")}/fasta/adapter.fasta"
    fastq_dir             = "${System.getProperty("user.home")}/fastq"
    cpus                  = 8
    
    // --- FeatureCounts & GTFè¨­å®š ---
    fc_group_features     = 'gene_id'
    // â˜…è¿½åŠ : GTFå†…ã®ã©ã®Featureã‚’ä½¿ã£ã¦ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ã‹
    // ä¸€èˆ¬çš„ã«ã¯ 'exon' ã§ã™ãŒã€ä»Šå›ã®èŒé¡ã‚²ãƒãƒ ã®ã‚ˆã†ã« 'CDS' ã—ã‹ãªã„å ´åˆã¯å®Ÿè¡Œæ™‚ã«å¤‰æ›´ã—ã¾ã™ã€‚
    gtf_feature_type      = 'exon'
    
    // --- STARè¨­å®š ---
    star_index_nbases     = 14
    // â˜…è¿½åŠ : BAMã‚½ãƒ¼ãƒˆã«ä½¿ã†ãƒ¡ãƒ¢ãƒªé‡ (STARå†…éƒ¨ç”¨)
    star_bam_sort_ram     = '30.GB'

    // --- De novoç”¨è¨­å®š ---
    denovo                = false 
    busco_lineage         = "eukaryota_odb10"
    busco_download_path   = "./busco_downloads"
}

process {
    // å…±é€šã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 2

    // STAR_ALIGN å°‚ç”¨ã®ãƒªã‚½ãƒ¼ã‚¹è¨­å®š
    withName: 'STAR_ALIGN' {
        // STARã¯ã€Œã‚²ãƒãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(ç´„30GB)ã€+ã€Œã‚½ãƒ¼ãƒˆç”¨ãƒ¡ãƒ¢ãƒª(30GB)ã€ã‚’ä½¿ã†ãŸã‚ã€
        // åˆè¨ˆã§60GBä»¥ä¸Šç¢ºä¿ã™ã‚‹ã®ãŒå®‰å…¨ã§ã™ã€‚
        memory = '64 GB' 
        cpus   = 16
    }
}

profiles {
    standard {
        apptainer.enabled    = true
        apptainer.autoMounts = true
        docker.enabled       = false
        apptainer.cacheDir   = "${System.getProperty("user.home")}/apptainer_images"
    }

    apptainer {
        apptainer.enabled    = true
        apptainer.autoMounts = true
        docker.enabled       = false
        apptainer.cacheDir   = "${System.getProperty("user.home")}/apptainer_images"
    }

    docker {
        docker.enabled       = true
        docker.runOptions    = '-u $(id -u):$(id -g)'
        apptainer.enabled    = false
    }
}

// --- ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ---
timeline {
    enabled = true
    file    = "${params.tracedir}/execution_timeline_${timestamp}.html"
}
report {
    enabled = true
    file    = "${params.tracedir}/execution_report_${timestamp}.html"
}